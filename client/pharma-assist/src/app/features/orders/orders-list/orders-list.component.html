<!-- Templates - defined at root level so ViewChild can always find them -->
<ng-template #orderNumberTemplate let-row>
  <div class="order-number-cell">
    <span class="order-number">{{ row.orderNumber }}</span>
  </div>
</ng-template>

<ng-template #customerTemplate let-row>
  <div class="customer-cell">
    <span class="customer-name">{{ row.customerName }}</span>
  </div>
</ng-template>

<ng-template #orderStatusTemplate let-row>
  <app-status-badge
    [label]="getOrderStatusLabel(row.status)"
    [variant]="getOrderStatusBadgeVariant(row.status)"
    [shouldTranslate]="true"
    [dot]="true"
  ></app-status-badge>
</ng-template>

<ng-template #paymentStatusTemplate let-row>
  <app-status-badge
    [label]="getPaymentStatusLabel(row.paymentStatus)"
    [variant]="getPaymentStatusBadgeVariant(row.paymentStatus)"
    [shouldTranslate]="true"
    [dot]="true"
  ></app-status-badge>
</ng-template>

<ng-template #dateTemplate let-row>
  <span class="date-cell">{{ row.orderDate | europeanDate:'datetime' }}</span>
</ng-template>

<ng-template #amountTemplate let-row>
  <span class="amount-cell">{{ row.totalAmount | number:'1.2-2' }}</span>
</ng-template>

<ng-template #itemsTemplate let-row>
  <span class="items-count">{{ row.itemCount }}</span>
</ng-template>

<ng-template #actionsTemplate let-row>
  <div class="actions">
    <button class="btn-icon" (click)="viewOrder(row); $event.stopPropagation()" [title]="'common.view' | translate">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
        <circle cx="12" cy="12" r="3"/>
      </svg>
    </button>
    @if (canEditOrder(row)) {
      <button class="btn-icon" (click)="editOrder(row); $event.stopPropagation()" [title]="'common.edit' | translate">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
        </svg>
      </button>
    }
    @if (canCancelOrder(row)) {
      <button class="btn-icon btn-danger" (click)="confirmCancelOrder(row); $event.stopPropagation()" [title]="'orders.cancel' | translate">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="15" y1="9" x2="9" y2="15"/>
          <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
      </button>
    }
  </div>
</ng-template>

<div class="orders-page">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">{{ 'orders.title' | translate }}</h1>
      <p class="page-subtitle">{{ 'orders.subtitle' | translate }}</p>
    </div>
    <div class="header-actions">
      <div class="export-dropdown" [class.open]="showExportMenu()">
        <button class="btn btn-secondary" (click)="toggleExportMenu()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          {{ 'common.export' | translate }}
        </button>
        @if (showExportMenu()) {
          <div class="export-menu">
            <button class="export-menu-item" (click)="exportToCSV()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="16" y1="13" x2="8" y2="13"/>
              <line x1="16" y1="17" x2="8" y2="17"/>
            </svg>
            CSV
          </button>
          <button class="export-menu-item" (click)="exportToExcel()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <rect x="8" y="12" width="8" height="6"/>
            </svg>
            Excel
          </button>
          <button class="export-menu-item" (click)="exportToPDF()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <path d="M10 12h4"/>
              <path d="M10 16h4"/>
            </svg>
            PDF
          </button>
          </div>
        }
      </div>
      <button class="btn btn-primary" (click)="createNewOrder()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 5v14M5 12h14"/>
        </svg>
        {{ 'orders.newOrder' | translate }}
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-row">
    <div class="stat-card" (click)="onStatCardClick(1)">
      <div class="stat-icon pending">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ pendingCount() }}</span>
        <span class="stat-label">{{ 'orders.stats.pending' | translate }}</span>
      </div>
    </div>
    <div class="stat-card" (click)="onStatCardClick(3)">
      <div class="stat-icon processing">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ processingCount() }}</span>
        <span class="stat-label">{{ 'orders.stats.processing' | translate }}</span>
      </div>
    </div>
    <div class="stat-card" (click)="onStatCardClick(5)">
      <div class="stat-icon shipped">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="1" y="3" width="15" height="13"/>
          <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/>
          <circle cx="5.5" cy="18.5" r="2.5"/>
          <circle cx="18.5" cy="18.5" r="2.5"/>
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ shippedCount() }}</span>
        <span class="stat-label">{{ 'orders.stats.shipped' | translate }}</span>
      </div>
    </div>
    <div class="stat-card" (click)="onStatCardClick(6)">
      <div class="stat-icon delivered">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
          <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ deliveredCount() }}</span>
        <span class="stat-label">{{ 'orders.stats.delivered' | translate }}</span>
      </div>
    </div>
  </div>

  <!-- Search + Filters Bar -->
  <div class="filters-bar">
    <app-search-input
      [placeholder]="'orders.searchPlaceholder' | translate"
      [debounceTime]="300"
      (searchChange)="onSearch($event)"
    ></app-search-input>

    <div class="filter-group">
      <select [(ngModel)]="selectedStatus" (ngModelChange)="onStatusFilterChange($event)" class="filter-select">
        <option [ngValue]="null">{{ 'orders.allStatuses' | translate }}</option>
        @for (status of orderStatusOptions; track status.value) {
          <option [ngValue]="status.value">{{ status.label | translate }}</option>
        }
      </select>

      <select [(ngModel)]="selectedPaymentStatus" (ngModelChange)="onPaymentStatusFilterChange($event)" class="filter-select">
        <option [ngValue]="null">{{ 'orders.allPaymentStatuses' | translate }}</option>
        @for (status of paymentStatusOptions; track status.value) {
          <option [ngValue]="status.value">{{ status.label | translate }}</option>
        }
      </select>

      <div class="date-input-wrapper">
        <input
          type="text"
          [(ngModel)]="fromDate"
          (ngModelChange)="onDateFilterChange()"
          placeholder="dd.MM.yyyy"
          class="filter-select date-filter"
        />
        <input
          type="date"
          class="hidden-date-picker"
          (change)="onNativeFromDateChange($event)"
          #fromDatePicker
        />
        <button type="button" class="calendar-icon" (click)="fromDatePicker.showPicker()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
            <line x1="16" y1="2" x2="16" y2="6"/>
            <line x1="8" y1="2" x2="8" y2="6"/>
            <line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
        </button>
      </div>
      <div class="date-input-wrapper">
        <input
          type="text"
          [(ngModel)]="toDate"
          (ngModelChange)="onDateFilterChange()"
          placeholder="dd.MM.yyyy"
          class="filter-select date-filter"
        />
        <input
          type="date"
          class="hidden-date-picker"
          (change)="onNativeToDateChange($event)"
          #toDatePicker
        />
        <button type="button" class="calendar-icon" (click)="toDatePicker.showPicker()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
            <line x1="16" y1="2" x2="16" y2="6"/>
            <line x1="8" y1="2" x2="8" y2="6"/>
            <line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
        </button>
      </div>

      @if (hasActiveFilters()) {
        <button class="btn btn-ghost" (click)="clearFilters()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
          {{ 'common.clearFilters' | translate }}
        </button>
      }
    </div>
  </div>

  <!-- Orders Table -->
  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>{{ 'common.loading' | translate }}</p>
    </div>
  } @else if (orders().length === 0 && !hasActiveFilters()) {
    <app-empty-state
      icon="package"
      [title]="'orders.empty.title' | translate"
      [description]="'orders.empty.description' | translate"
      [actionLabel]="'orders.newOrder' | translate"
      (actionClick)="createNewOrder()"
    ></app-empty-state>
  } @else if (orders().length === 0 && hasActiveFilters()) {
    <app-empty-state
      icon="search"
      [title]="'common.noSearchResults' | translate"
      [description]="'common.tryDifferentSearch' | translate"
    ></app-empty-state>
  } @else {
    <app-data-table
      [data]="orders()"
      [columns]="columns"
      [selectable]="true"
      [hoverable]="true"
      [striped]="true"
      [compact]="true"
      (rowClick)="viewOrder($event)"
      (sortChange)="onSortChange($event)"
      (selectionChange)="onSelectionChange($event)"
    >
    </app-data-table>

    <!-- Pagination -->
    <div class="pagination-container">
      <app-pagination
        [page]="currentPage()"
        [size]="pageSize"
        [totalItems]="totalItems()"
        (pageChange)="onPageChange($event)"
      ></app-pagination>
    </div>
  }

  <!-- Bulk Actions Bar -->
  @if (selectedOrders().length > 0) {
    <div class="bulk-actions-bar">
      <span class="selection-count">
        {{ selectedOrders().length }} {{ 'common.selected' | translate }}
      </span>
      <div class="bulk-buttons">
        <button class="btn btn-secondary" (click)="exportSelected()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          {{ 'common.export' | translate }}
        </button>
        <button class="btn btn-ghost" (click)="clearSelection()">
          {{ 'common.clearSelection' | translate }}
        </button>
      </div>
    </div>
  }

  <!-- Cancel Order Confirmation -->
  <app-confirm-dialog
    [isOpen]="showCancelConfirm()"
    [title]="'orders.cancelConfirm.title' | translate"
    [message]="'orders.cancelConfirm.message' | translate"
    [confirmLabel]="'orders.cancel' | translate"
    [cancelLabel]="'common.goBack' | translate"
    variant="danger"
    (confirm)="cancelOrder()"
    (cancel)="closeCancelConfirm()"
  ></app-confirm-dialog>
</div>
