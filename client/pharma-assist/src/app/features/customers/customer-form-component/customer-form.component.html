<div class="customer-form-page">
  <!-- Header -->
  <div class="page-header">
    <a routerLink="/customers" class="btn-back">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="m15 18-6-6 6-6"/>
      </svg>
      {{ 'common.back' | translate }}
    </a>
    <div class="header-content">
      <h1>{{ isEditMode() ? ('customers.editCustomer' | translate) : ('customers.addCustomer' | translate) }}</h1>
      <p class="subtitle">{{ isEditMode() ? ('customers.editSubtitle' | translate) : ('customers.addSubtitle' | translate) }}</p>
    </div>
  </div>

  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>{{ 'common.loading' | translate }}</p>
    </div>
  } @else {
    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="form-container">
      <!-- Basic Information Section -->
      <div class="form-section">
        <h2>{{ 'customers.basicInfo' | translate }}</h2>

        <div class="form-grid">
          <div class="form-group full-width">
            <label for="name">{{ 'customers.form.name' | translate }} *</label>
            <input
              type="text"
              id="name"
              formControlName="name"
              [placeholder]="'customers.form.namePlaceholder' | translate"
              [class.error]="isFieldInvalid('name')"
            >
            @if (isFieldInvalid('name')) {
              <span class="error-text">{{ 'validation.required' | translate }}</span>
            }
          </div>

          <div class="form-group">
            <label for="customerType">{{ 'customers.form.type' | translate }} *</label>
            <select id="customerType" formControlName="customerType" [class.error]="isFieldInvalid('customerType')">
              <option [ngValue]="null">{{ 'customers.selectType' | translate }}</option>
              @for (type of customerTypes; track type.value) {
                <option [ngValue]="type.value">{{ type.label | translate }}</option>
              }
            </select>
          </div>

          <div class="form-group">
            <label for="tier">{{ 'customers.form.tier' | translate }} *</label>
            <select id="tier" formControlName="tier" [class.error]="isFieldInvalid('tier')">
              @for (tier of tiers; track tier.value) {
                <option [ngValue]="tier.value">{{ tier.label | translate }}</option>
              }
            </select>
          </div>
        </div>
      </div>

      <!-- Contact Information Section -->
      <div class="form-section">
        <h2>{{ 'customers.contactInfo' | translate }}</h2>

        <div class="form-grid">
          <div class="form-group">
            <label for="email">{{ 'customers.form.email' | translate }} *</label>
            <input
              type="email"
              id="email"
              formControlName="email"
              [placeholder]="'customers.form.emailPlaceholder' | translate"
              [class.error]="isFieldInvalid('email')"
            >
            @if (isFieldInvalid('email')) {
              <span class="error-text">{{ getEmailError() }}</span>
            }
          </div>

          <div class="form-group">
            <label for="phone">{{ 'customers.form.phone' | translate }}</label>
            <input
              type="tel"
              id="phone"
              formControlName="phone"
              [placeholder]="'customers.form.phonePlaceholder' | translate"
            >
          </div>

          <div class="form-group full-width">
            <label for="contactPerson">{{ 'customers.form.contactPerson' | translate }}</label>
            <input
              type="text"
              id="contactPerson"
              formControlName="contactPerson"
              [placeholder]="'customers.form.contactPersonPlaceholder' | translate"
            >
          </div>
        </div>
      </div>

      <!-- Business Details Section -->
      <div class="form-section">
        <h2>{{ 'customers.businessDetails' | translate }}</h2>

        <div class="form-grid">
          <div class="form-group">
            <label for="taxId">{{ 'customers.form.taxId' | translate }}</label>
            <input
              type="text"
              id="taxId"
              formControlName="taxId"
              [placeholder]="'customers.form.taxIdPlaceholder' | translate"
            >
          </div>

          <div class="form-group">
            <label for="registrationNumber">{{ 'customers.form.registrationNumber' | translate }}</label>
            <input
              type="text"
              id="registrationNumber"
              formControlName="registrationNumber"
              [placeholder]="'customers.form.registrationNumberPlaceholder' | translate"
            >
          </div>

          @if (showPharmacyLicense()) {
            <div class="form-group">
              <label for="pharmacyLicense">{{ 'customers.form.pharmacyLicense' | translate }}</label>
              <input
                type="text"
                id="pharmacyLicense"
                formControlName="pharmacyLicense"
                [placeholder]="'customers.form.pharmacyLicensePlaceholder' | translate"
              >
            </div>
          }
        </div>
      </div>

      <!-- Financial Terms Section -->
      <div class="form-section">
        <h2>{{ 'customers.financialTerms' | translate }}</h2>

        <div class="form-grid">
          <div class="form-group">
            <label for="discountPercentage">{{ 'customers.form.discount' | translate }} (%)</label>
            <input
              type="number"
              id="discountPercentage"
              formControlName="discountPercentage"
              min="0"
              max="100"
              step="0.5"
            >
          </div>

          <div class="form-group">
            <label for="creditLimit">{{ 'customers.form.creditLimit' | translate }} (BAM)</label>
            <input
              type="number"
              id="creditLimit"
              formControlName="creditLimit"
              min="0"
              step="100"
            >
          </div>

          <div class="form-group">
            <label for="paymentTermDays">{{ 'customers.form.paymentTerms' | translate }}</label>
            <select id="paymentTermDays" formControlName="paymentTermDays">
              <option [ngValue]="0">{{ 'customers.paymentTerms.immediate' | translate }}</option>
              <option [ngValue]="7">{{ 'customers.paymentTerms.net7' | translate }}</option>
              <option [ngValue]="15">{{ 'customers.paymentTerms.net15' | translate }}</option>
              <option [ngValue]="30">{{ 'customers.paymentTerms.net30' | translate }}</option>
              <option [ngValue]="45">{{ 'customers.paymentTerms.net45' | translate }}</option>
              <option [ngValue]="60">{{ 'customers.paymentTerms.net60' | translate }}</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Primary Address Section -->
      <div class="form-section" formGroupName="primaryAddress">
        <h2>{{ 'customers.primaryAddress' | translate }}</h2>

        <div class="form-grid">
          <div class="form-group">
            <label for="canton">{{ 'customers.form.canton' | translate }} *</label>
            <select id="canton" formControlName="cantonId" (change)="onCantonChange()" [class.error]="isAddressFieldInvalid('cantonId')">
              <option [ngValue]="null">{{ 'customers.selectCanton' | translate }}</option>
              @for (canton of cantons(); track canton.id) {
                <option [ngValue]="canton.id">{{ cantonLabel(canton) }}</option>
              }
            </select>
          </div>

          <div class="form-group">
            <label for="city">{{ 'customers.form.city' | translate }} *</label>
            <select id="city" formControlName="cityId" [class.error]="isAddressFieldInvalid('cityId')">
              <option [ngValue]="null">{{ 'customers.selectCity' | translate }}</option>
              @for (city of filteredCities(); track city.id) {
                <option [ngValue]="city.id">{{ city.name }}</option>
              }
            </select>
          </div>

          <div class="form-group full-width">
            <label for="street">{{ 'customers.form.street' | translate }} *</label>
            <input
              type="text"
              id="street"
              formControlName="street"
              [placeholder]="'customers.form.streetPlaceholder' | translate"
              [class.error]="isAddressFieldInvalid('street')"
            >
          </div>

          <div class="form-group">
            <label for="buildingNumber">{{ 'customers.form.buildingNumber' | translate }}</label>
            <input
              type="text"
              id="buildingNumber"
              formControlName="buildingNumber"
              placeholder="e.g., 12A"
            >
          </div>

          <div class="form-group">
            <label for="postalCode">{{ 'customers.form.postalCode' | translate }} *</label>
            <input
              type="text"
              id="postalCode"
              formControlName="postalCode"
              placeholder="e.g., 71000"
              [class.error]="isAddressFieldInvalid('postalCode')"
            >
          </div>

          <div class="form-group">
            <label for="addressType">{{ 'customers.form.addressType' | translate }}</label>
            <select id="addressType" formControlName="addressType">
              @for (type of addressTypes; track type.value) {
                <option [ngValue]="type.value">{{ type.label | translate }}</option>
              }
            </select>
          </div>

          <div class="form-group full-width">
            <label for="addressNotes">{{ 'customers.form.addressNotes' | translate }}</label>
            <textarea
              id="addressNotes"
              formControlName="notes"
              rows="2"
              [placeholder]="'customers.form.addressNotesPlaceholder' | translate"
            ></textarea>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <a routerLink="/customers" class="btn btn-secondary">
          {{ 'common.cancel' | translate }}
        </a>
        <button type="submit" class="btn btn-primary" [disabled]="submitting() || form.invalid">
          @if (submitting()) {
            <span class="spinner-sm"></span>
          }
          {{ isEditMode() ? ('common.update' | translate) : ('common.create' | translate) }}
        </button>
      </div>
    </form>
  }
</div>
