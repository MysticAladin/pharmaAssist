<div class="prescriptions-page">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">{{ 'prescriptions.title' | translate }}</h1>
      <p class="page-subtitle">{{ 'prescriptions.subtitle' | translate }}</p>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-row">
    <div class="stat-card" [class.active]="activeTab() === 'pending'" (click)="setTab('pending')">
      <div class="stat-icon pending">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ stats()?.pending || 0 }}</span>
        <span class="stat-label">{{ 'prescriptions.stats.pending' | translate }}</span>
      </div>
    </div>
    <div class="stat-card" [class.active]="activeTab() === 'review'" (click)="setTab('review')">
      <div class="stat-icon review">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ stats()?.underReview || 0 }}</span>
        <span class="stat-label">{{ 'prescriptions.stats.underReview' | translate }}</span>
      </div>
    </div>
    <div class="stat-card" [class.active]="activeTab() === 'approved'" (click)="setTab('approved')">
      <div class="stat-icon approved">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ stats()?.approved || 0 }}</span>
        <span class="stat-label">{{ 'prescriptions.stats.approved' | translate }}</span>
      </div>
    </div>
    <div class="stat-card" [class.active]="activeTab() === 'dispensed'" (click)="setTab('dispensed')">
      <div class="stat-icon dispensed">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ stats()?.dispensed || 0 }}</span>
        <span class="stat-label">{{ 'prescriptions.stats.dispensed' | translate }}</span>
      </div>
    </div>
  </div>

  <!-- Urgent Alert -->
  @if (stats()?.urgentCount && stats()!.urgentCount > 0) {
    <div class="urgent-alert">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
        <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
      </svg>
      <span>{{ stats()!.urgentCount }} {{ 'prescriptions.urgentAlert' | translate }}</span>
      @if (stats()?.controlledCount && stats()!.controlledCount > 0) {
        <span class="controlled-badge">{{ stats()!.controlledCount }} {{ 'prescriptions.controlled' | translate }}</span>
      }
    </div>
  }

  <!-- Filters Bar -->
  <div class="filters-bar">
    <app-search-input
      [placeholder]="'prescriptions.searchPlaceholder'"
      (search)="onSearch($event)"
    ></app-search-input>

    <div class="filter-group">
      <select class="filter-select" [ngModel]="filter().priority" (ngModelChange)="onPriorityChange($event)">
        <option [ngValue]="undefined">{{ 'prescriptions.allPriorities' | translate }}</option>
        <option [ngValue]="0">{{ 'prescriptions.priority.normal' | translate }}</option>
        <option [ngValue]="1">{{ 'prescriptions.priority.urgent' | translate }}</option>
        <option [ngValue]="2">{{ 'prescriptions.priority.emergency' | translate }}</option>
      </select>

      <label class="filter-checkbox">
        <input type="checkbox" [ngModel]="filter().isControlled" (ngModelChange)="onControlledChange($event)">
        <span>{{ 'prescriptions.controlledOnly' | translate }}</span>
      </label>
    </div>
  </div>

  <!-- Prescriptions List -->
  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>{{ 'common.loading' | translate }}</p>
    </div>
  } @else if (prescriptions().length === 0) {
    <app-empty-state
      [title]="'prescriptions.empty.title'"
      [description]="'prescriptions.empty.description'"
      icon="file-text"
    ></app-empty-state>
  } @else {
    <div class="prescriptions-list">
      @for (rx of prescriptions(); track rx.id) {
        <div class="prescription-card" [class.urgent]="rx.priority === 1" [class.emergency]="rx.priority === 2" (click)="viewPrescription(rx)">
          <div class="card-header">
            <div class="rx-number">
              <span class="number">{{ rx.prescriptionNumber }}</span>
              @if (rx.isControlled) {
                <span class="controlled-tag">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                  </svg>
                  {{ 'prescriptions.controlled' | translate }}
                </span>
              }
            </div>
            <div class="rx-badges">
              @if (rx.priority !== 0) {
                <app-status-badge [variant]="getPriorityColor(rx.priority)" [label]="getPriorityLabel(rx.priority) | translate"></app-status-badge>
              }
              <app-status-badge [variant]="getStatusColor(rx.status)" [label]="getStatusLabel(rx.status) | translate"></app-status-badge>
            </div>
          </div>

          <div class="card-body">
            <div class="info-row">
              <div class="info-item">
                <span class="label">{{ 'prescriptions.patient' | translate }}</span>
                <span class="value">{{ rx.patientName }}</span>
              </div>
              <div class="info-item">
                <span class="label">{{ 'prescriptions.doctor' | translate }}</span>
                <span class="value">{{ rx.doctorName }}</span>
              </div>
            </div>
            <div class="info-row">
              <div class="info-item">
                <span class="label">{{ 'prescriptions.customer' | translate }}</span>
                <span class="value">{{ rx.customerName }}</span>
              </div>
              <div class="info-item">
                <span class="label">{{ 'prescriptions.items' | translate }}</span>
                <span class="value">{{ rx.itemCount }} {{ 'prescriptions.medications' | translate }}</span>
              </div>
            </div>
          </div>

          <div class="card-footer">
            <div class="dates">
              <span class="date">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/>
                  <line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                {{ rx.issueDate | europeanDate }}
              </span>
              <span class="date expiry" [class.expired]="isExpired(rx.expiryDate)">
                {{ 'prescriptions.expires' | translate }}: {{ rx.expiryDate | europeanDate }}
              </span>
            </div>
            <div class="actions">
              @if (rx.status === 0 || rx.status === 1) {
                <button class="btn-action approve" (click)="reviewPrescription(rx, true, $event)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"/>
                  </svg>
                  {{ 'prescriptions.approve' | translate }}
                </button>
                <button class="btn-action reject" (click)="reviewPrescription(rx, false, $event)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                  </svg>
                  {{ 'prescriptions.reject' | translate }}
                </button>
              }
              @if (rx.status === 2) {
                <button class="btn-action dispense" (click)="dispensePrescription(rx, $event)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                  </svg>
                  {{ 'prescriptions.dispense' | translate }}
                </button>
              }
            </div>
          </div>
        </div>
      }
    </div>

    <!-- Pagination -->
    <app-pagination
      [page]="filter().page"
      [size]="filter().pageSize"
      [totalItems]="totalCount()"
      (pageChange)="onPageChange($event)"
    ></app-pagination>
  }
</div>
