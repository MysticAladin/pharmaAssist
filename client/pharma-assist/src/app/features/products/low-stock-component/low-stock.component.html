<div class="low-stock-page">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">{{ 'lowStock.title' | translate }}</h1>
      <p class="page-description">{{ 'lowStock.description' | translate }}</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="exportReport()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        {{ 'common.export' | translate }}
      </button>
      <button class="btn btn-primary" routerLink="/products/new">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        {{ 'lowStock.reorder' | translate }}
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card critical">
      <div class="stat-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
          <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ criticalCount() }}</span>
        <span class="stat-label">{{ 'lowStock.critical' | translate }}</span>
      </div>
    </div>
    <div class="stat-card warning">
      <div class="stat-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ warningCount() }}</span>
        <span class="stat-label">{{ 'lowStock.warning' | translate }}</span>
      </div>
    </div>
    <div class="stat-card info">
      <div class="stat-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/>
          <circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/>
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ pendingOrdersCount() }}</span>
        <span class="stat-label">{{ 'lowStock.pendingOrders' | translate }}</span>
      </div>
    </div>
    <div class="stat-card total">
      <div class="stat-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
          <line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/>
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ totalLowStock() }}</span>
        <span class="stat-label">{{ 'lowStock.totalItems' | translate }}</span>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <app-search-input
      [placeholder]="'lowStock.searchPlaceholder' | translate"
      (search)="onSearch($event)"
    ></app-search-input>

    <div class="filter-group">
      <select class="filter-select" [(ngModel)]="selectedSeverity" (change)="applyFilters()">
        <option value="all">{{ 'lowStock.allSeverities' | translate }}</option>
        <option value="critical">{{ 'lowStock.critical' | translate }}</option>
        <option value="warning">{{ 'lowStock.warning' | translate }}</option>
      </select>

      <select class="filter-select" [(ngModel)]="threshold" (change)="loadProducts()">
        <option [value]="10">{{ 'lowStock.threshold' | translate }}: 10</option>
        <option [value]="25">{{ 'lowStock.threshold' | translate }}: 25</option>
        <option [value]="50">{{ 'lowStock.threshold' | translate }}: 50</option>
        <option [value]="100">{{ 'lowStock.threshold' | translate }}: 100</option>
      </select>
    </div>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-container">
      <div class="loading-grid">
        @for (i of [1,2,3,4,5]; track i) {
          <div class="skeleton-row">
            <div class="skeleton skeleton-cell"></div>
            <div class="skeleton skeleton-cell wide"></div>
            <div class="skeleton skeleton-cell"></div>
            <div class="skeleton skeleton-cell"></div>
            <div class="skeleton skeleton-cell"></div>
          </div>
        }
      </div>
    </div>
  } @else if (filteredProducts().length === 0) {
    <app-empty-state
      icon="package"
      [title]="'lowStock.empty.title' | translate"
      [description]="'lowStock.empty.description' | translate"
    ></app-empty-state>
  } @else {
    <!-- Products Table -->
    <div class="table-card">
      <table class="data-table">
        <thead>
          <tr>
            <th class="sortable" (click)="sortBy('name')">
              {{ 'lowStock.columns.product' | translate }}
              @if (sortColumn() === 'name') {
                <span class="sort-icon">{{ sortDirection() === 'asc' ? '↑' : '↓' }}</span>
              }
            </th>
            <th>{{ 'lowStock.columns.sku' | translate }}</th>
            <th>{{ 'lowStock.columns.category' | translate }}</th>
            <th class="text-right sortable" (click)="sortBy('stockQuantity')">
              {{ 'lowStock.columns.currentStock' | translate }}
              @if (sortColumn() === 'stockQuantity') {
                <span class="sort-icon">{{ sortDirection() === 'asc' ? '↑' : '↓' }}</span>
              }
            </th>
            <th class="text-right sortable" (click)="sortBy('reorderLevel')">
              {{ 'lowStock.columns.reorderLevel' | translate }}
              @if (sortColumn() === 'reorderLevel') {
                <span class="sort-icon">{{ sortDirection() === 'asc' ? '↑' : '↓' }}</span>
              }
            </th>
            <th class="text-center">{{ 'lowStock.columns.status' | translate }}</th>
            <th class="text-center">{{ 'common.actions' | translate }}</th>
          </tr>
        </thead>
        <tbody>
          @for (product of filteredProducts(); track product.id) {
            <tr [class.critical-row]="getStockLevel(product) === 'critical'">
              <td>
                <div class="product-info">
                  @if (product.imageUrl) {
                    <img [src]="product.imageUrl" [alt]="product.name" class="product-image">
                  } @else {
                    <div class="product-image-placeholder">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
                        <line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/>
                      </svg>
                    </div>
                  }
                  <div class="product-details">
                    <a [routerLink]="['/products', product.id]" class="product-name">{{ product.name }}</a>
                    <span class="product-local">{{ product.nameLocal }}</span>
                  </div>
                </div>
              </td>
              <td class="sku-cell">{{ product.sku }}</td>
              <td>{{ product.categoryName || '-' }}</td>
              <td class="text-right">
                <span class="stock-value" [class]="getStockLevel(product)">
                  {{ product.stockQuantity }}
                </span>
              </td>
              <td class="text-right">{{ product.reorderLevel }}</td>
              <td class="text-center">
                <app-status-badge
                  [variant]="getStockLevel(product) === 'critical' ? 'danger' : 'warning'"
                  [label]="(getStockLevel(product) === 'critical' ? 'lowStock.critical' : 'lowStock.warning') | translate"
                ></app-status-badge>
              </td>
              <td class="text-center">
                <div class="action-buttons">
                  <button class="btn-icon" [routerLink]="['/products', product.id]" [title]="'common.view' | translate">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                    </svg>
                  </button>
                  <button class="btn-icon btn-reorder" (click)="reorderProduct(product)" [title]="'lowStock.reorder' | translate">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
                      <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- Summary Footer -->
    <div class="summary-footer">
      <div class="summary-text">
        {{ 'lowStock.showing' | translate:{ count: filteredProducts().length, total: products().length } }}
      </div>
      <div class="estimated-value">
        <span class="value-label">{{ 'lowStock.estimatedReorderValue' | translate }}:</span>
        <span class="value-amount">{{ calculateReorderValue() | currency:'BAM ':'symbol':'1.2-2' }}</span>
      </div>
    </div>
  }
</div>
