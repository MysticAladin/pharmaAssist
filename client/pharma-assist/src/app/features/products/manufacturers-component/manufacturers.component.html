<div class="manufacturers-page">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">{{ 'manufacturers.title' | translate }}</h1>
      <p class="page-subtitle">{{ 'manufacturers.subtitle' | translate }}</p>
    </div>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 5v14M5 12h14"/>
      </svg>
      {{ 'manufacturers.addManufacturer' | translate }}
    </button>
  </div>

  <!-- Filters Bar -->
  <div class="filters-bar">
    <app-search-input
      [placeholder]="'common.search' | translate"
      [debounceTime]="300"
      (searchChange)="onSearch($event)"
    ></app-search-input>

    <div class="filter-group">
      <label class="toggle-filter">
        <input
          type="checkbox"
          [(ngModel)]="showActiveOnly"
          (ngModelChange)="filterManufacturers()"
        >
        <span>{{ 'common.activeOnly' | translate }}</span>
      </label>
    </div>
  </div>

  <!-- Column Templates (must exist even when table is not rendered yet) -->
  <ng-template #nameTemplate let-row>
    <div class="manufacturer-name-cell">
      <div class="manufacturer-icon">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 21h18"/>
          <path d="M5 21V7l8-4v18"/>
          <path d="M19 21V11l-6-4"/>
          <path d="M9 9v.01"/>
          <path d="M9 12v.01"/>
          <path d="M9 15v.01"/>
          <path d="M9 18v.01"/>
        </svg>
      </div>
      <div class="manufacturer-info">
        <span class="manufacturer-name">{{ row.name }}</span>
        @if (row.nameLocal && row.nameLocal !== row.name) {
          <span class="manufacturer-name-local">{{ row.nameLocal }}</span>
        }
      </div>
    </div>
  </ng-template>

  <ng-template #countryTemplate let-row>
    @if (row.country) {
      <div class="country-cell">
        @if (row.countryCode) {
          <span class="country-code">{{ row.countryCode }}</span>
        }
        <span class="country-name">{{ row.country }}</span>
      </div>
    } @else {
      <span class="no-value">—</span>
    }
  </ng-template>

  <ng-template #contactTemplate let-row>
    <div class="contact-cell">
      @if (row.contactEmail) {
        <a [href]="'mailto:' + row.contactEmail" class="contact-link" (click)="$event.stopPropagation()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
            <polyline points="22,6 12,13 2,6"/>
          </svg>
          {{ row.contactEmail }}
        </a>
      }
      @if (row.contactPhone) {
        <a [href]="'tel:' + row.contactPhone" class="contact-link" (click)="$event.stopPropagation()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
          </svg>
          {{ row.contactPhone }}
        </a>
      }
      @if (!row.contactEmail && !row.contactPhone) {
        <span class="no-value">—</span>
      }
    </div>
  </ng-template>

  <ng-template #websiteTemplate let-row>
    @if (row.website) {
      <a [href]="row.website" target="_blank" class="website-link" (click)="$event.stopPropagation()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="2" y1="12" x2="22" y2="12"/>
          <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
        </svg>
        {{ getWebsiteDisplay(row.website) }}
      </a>
    } @else {
      <span class="no-value">—</span>
    }
  </ng-template>

  <ng-template #productsTemplate let-row>
    <span class="product-count">{{ row.productCount || 0 }}</span>
  </ng-template>

  <ng-template #statusTemplate let-row>
    <app-status-badge
      [label]="row.isActive ? 'common.active' : 'common.inactive'"
      [variant]="row.isActive ? 'success' : 'neutral'"
      [shouldTranslate]="true"
      [dot]="true"
    ></app-status-badge>
  </ng-template>

  <ng-template #actionsTemplate let-row>
    <div class="action-buttons">
      <button class="btn-icon" (click)="editManufacturer(row); $event.stopPropagation()" [title]="'common.edit' | translate">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
        </svg>
      </button>
      <button
        class="btn-icon btn-icon-danger"
        (click)="confirmDelete(row); $event.stopPropagation()"
        [title]="'common.delete' | translate"
        [disabled]="(row.productCount || 0) > 0"
      >
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="3 6 5 6 21 6"/>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
          <line x1="10" y1="11" x2="10" y2="17"/>
          <line x1="14" y1="11" x2="14" y2="17"/>
        </svg>
      </button>
    </div>
  </ng-template>

  <!-- Manufacturers Table -->
  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>{{ 'common.loading' | translate }}</p>
    </div>
  } @else if (filteredManufacturers().length === 0 && !searchTerm) {
    <app-empty-state
      icon="building"
      [title]="'manufacturers.empty.title' | translate"
      [description]="'manufacturers.empty.description' | translate"
      [actionLabel]="'manufacturers.addManufacturer' | translate"
      (actionClick)="openCreateModal()"
    ></app-empty-state>
  } @else if (filteredManufacturers().length === 0 && searchTerm) {
    <app-empty-state
      icon="search"
      [title]="'common.noSearchResults' | translate"
      [description]="'common.tryDifferentSearch' | translate"
    ></app-empty-state>
  } @else {
    <app-data-table
      [data]="filteredManufacturers()"
      [columns]="columns"
      [selectable]="false"
      [hoverable]="true"
      [striped]="true"
      (rowClick)="onRowClick($event)"
    ></app-data-table>
  }

  <!-- Manufacturer Form Modal -->
  <app-modal
    [isOpen]="showFormModal()"
    [title]="(editingManufacturer() ? 'manufacturers.editManufacturer' : 'manufacturers.addManufacturer') | translate"
    [size]="'large'"
    (closeModal)="closeFormModal()"
  >
    <div class="modal-body" body>
      <form class="manufacturer-form" (ngSubmit)="saveManufacturer()">
        <div class="form-section">
          <h3 class="section-title">{{ 'manufacturers.form.basicInfo' | translate }}</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="name">{{ 'manufacturers.form.name' | translate }} *</label>
              <input
                type="text"
                id="name"
                [(ngModel)]="formData.name"
                name="name"
                class="form-control"
                required
                [placeholder]="'manufacturers.form.namePlaceholder' | translate"
              >
            </div>
            <div class="form-group">
              <label for="nameLocal">{{ 'manufacturers.form.nameLocal' | translate }}</label>
              <input
                type="text"
                id="nameLocal"
                [(ngModel)]="formData.nameLocal"
                name="nameLocal"
                class="form-control"
                [placeholder]="'manufacturers.form.nameLocalPlaceholder' | translate"
              >
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="country">{{ 'manufacturers.form.country' | translate }}</label>
              <input
                type="text"
                id="country"
                [(ngModel)]="formData.country"
                name="country"
                class="form-control"
                [placeholder]="'manufacturers.form.countryPlaceholder' | translate"
              >
            </div>
            <div class="form-group">
              <label for="countryCode">{{ 'manufacturers.form.countryCode' | translate }}</label>
              <input
                type="text"
                id="countryCode"
                [(ngModel)]="formData.countryCode"
                name="countryCode"
                class="form-control"
                maxlength="3"
                [placeholder]="'manufacturers.form.countryCodePlaceholder' | translate"
              >
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3 class="section-title">{{ 'manufacturers.form.contactInfo' | translate }}</h3>
          <div class="form-group">
            <label for="website">{{ 'manufacturers.form.website' | translate }}</label>
            <input
              type="url"
              id="website"
              [(ngModel)]="formData.website"
              name="website"
              class="form-control"
              [placeholder]="'manufacturers.form.websitePlaceholder' | translate"
            >
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="contactEmail">{{ 'manufacturers.form.email' | translate }}</label>
              <input
                type="email"
                id="contactEmail"
                [(ngModel)]="formData.contactEmail"
                name="contactEmail"
                class="form-control"
                [placeholder]="'manufacturers.form.emailPlaceholder' | translate"
              >
            </div>
            <div class="form-group">
              <label for="contactPhone">{{ 'manufacturers.form.phone' | translate }}</label>
              <input
                type="tel"
                id="contactPhone"
                [(ngModel)]="formData.contactPhone"
                name="contactPhone"
                class="form-control"
                [placeholder]="'manufacturers.form.phonePlaceholder' | translate"
              >
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input
              type="checkbox"
              [(ngModel)]="formData.isActive"
              name="isActive"
            >
            <span>{{ 'manufacturers.form.isActive' | translate }}</span>
          </label>
        </div>
      </form>
    </div>
    <div class="modal-footer" footer>
      <button type="button" class="btn btn-secondary" (click)="closeFormModal()">
        {{ 'common.cancel' | translate }}
      </button>
      <button
        type="button"
        class="btn btn-primary"
        (click)="saveManufacturer()"
        [disabled]="saving() || !formData.name"
      >
        @if (saving()) {
          <span class="spinner-small"></span>
        }
        {{ (editingManufacturer() ? 'common.save' : 'common.create') | translate }}
      </button>
    </div>
  </app-modal>

  <!-- Delete Confirmation Dialog -->
  <app-confirm-dialog
    [isOpen]="showDeleteDialog()"
    [title]="'manufacturers.delete.title' | translate"
    [message]="'manufacturers.delete.message' | translate : { name: deletingManufacturer()?.name }"
    [confirmLabel]="'common.delete' | translate"
    [cancelLabel]="'common.cancel' | translate"
    variant="danger"
    (confirmed)="deleteManufacturer()"
    (cancelled)="cancelDelete()"
  ></app-confirm-dialog>
</div>
