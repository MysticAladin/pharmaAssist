<div class="product-form-page">
  <!-- Header -->
  <div class="page-header">
    <div class="breadcrumb">
      <a routerLink="/products">{{ 'products.title' | translate }}</a>
      <span class="separator">/</span>
      <span>{{ isEditMode() ? ('products.form.editProduct' | translate) : ('products.form.addProduct' | translate) }}</span>
    </div>
    <div class="header-main">
      <h1 class="page-title">{{ isEditMode() ? ('products.form.editProduct' | translate) : ('products.form.addProduct' | translate) }}</h1>
      <div class="header-actions">
        <button type="button" class="btn-secondary" routerLink="/products">
          {{ 'common.cancel' | translate }}
        </button>
        <button type="button" class="btn-primary" (click)="save()" [disabled]="saving()">
          @if (saving()) {
            <span class="spinner"></span>
          }
          {{ 'common.save' | translate }}
        </button>
      </div>
    </div>
  </div>

  @if (loading()) {
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p>{{ 'common.loading' | translate }}</p>
    </div>
  } @else {
    <form class="form-container" (ngSubmit)="save()">
      <!-- Basic Information -->
      <section class="form-section">
        <h2 class="section-title">{{ 'products.form.basicInfo' | translate }}</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="name">{{ 'products.form.name' | translate }} *</label>
            <input type="text" id="name" [(ngModel)]="form.name" name="name" required
                   [placeholder]="'products.form.namePlaceholder' | translate">
          </div>
          <div class="form-group">
            <label for="nameLocal">{{ 'products.form.nameLocal' | translate }} *</label>
            <input type="text" id="nameLocal" [(ngModel)]="form.nameLocal" name="nameLocal" required
                   [placeholder]="'products.form.nameLocalPlaceholder' | translate">
          </div>
          <div class="form-group">
            <label for="genericName">{{ 'products.form.genericName' | translate }}</label>
            <input type="text" id="genericName" [(ngModel)]="form.genericName" name="genericName"
                   [placeholder]="'products.form.genericNamePlaceholder' | translate">
          </div>
          <div class="form-group">
            <label for="sku">{{ 'products.form.sku' | translate }} *</label>
            <input type="text" id="sku" [(ngModel)]="form.sku" name="sku" required
                   [placeholder]="'products.form.skuPlaceholder' | translate">
          </div>
          <div class="form-group">
            <label for="barcode">{{ 'products.form.barcode' | translate }}</label>
            <input type="text" id="barcode" [(ngModel)]="form.barcode" name="barcode"
                   placeholder="1234567890123">
          </div>
          <div class="form-group">
            <label for="atcCode">{{ 'products.form.atcCode' | translate }}</label>
            <input type="text" id="atcCode" [(ngModel)]="form.atcCode" name="atcCode"
                   placeholder="A01AA01">
          </div>
          <div class="form-group full-width">
            <label for="description">{{ 'products.form.description' | translate }}</label>
            <textarea id="description" [(ngModel)]="form.description" name="description" rows="3"
                      [placeholder]="'products.form.descriptionPlaceholder' | translate"></textarea>
          </div>
          <div class="form-group full-width">
            <label for="descriptionLocal">{{ 'products.form.descriptionLocal' | translate }}</label>
            <textarea id="descriptionLocal" [(ngModel)]="form.descriptionLocal" name="descriptionLocal" rows="3"
                      [placeholder]="'products.form.descriptionLocalPlaceholder' | translate"></textarea>
          </div>
        </div>
      </section>

      <!-- Classification -->
      <section class="form-section">
        <h2 class="section-title">{{ 'products.form.classification' | translate }}</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="categoryId">{{ 'products.form.category' | translate }} *</label>
            <select id="categoryId" [(ngModel)]="form.categoryId" name="categoryId" required>
              <option [ngValue]="null">{{ 'products.form.selectCategory' | translate }}</option>
              @for (category of categories(); track category.id) {
                <option [ngValue]="category.id">{{ category.name }}</option>
              }
            </select>
          </div>
          <div class="form-group">
            <label for="manufacturerId">{{ 'products.form.manufacturer' | translate }} *</label>
            <select id="manufacturerId" [(ngModel)]="form.manufacturerId" name="manufacturerId" required>
              <option [ngValue]="null">{{ 'products.form.selectManufacturer' | translate }}</option>
              @for (mfr of manufacturers(); track mfr.id) {
                <option [ngValue]="mfr.id">{{ mfr.name }}</option>
              }
            </select>
          </div>
        </div>
      </section>

      <!-- Pharmaceutical Details -->
      <section class="form-section">
        <h2 class="section-title">{{ 'products.form.pharmaDetails' | translate }}</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="dosageForm">{{ 'products.form.dosageForm' | translate }}</label>
            <select id="dosageForm" [(ngModel)]="form.dosageForm" name="dosageForm">
              <option value="">{{ 'products.form.selectDosageForm' | translate }}</option>
              <option value="Tablet">{{ 'products.dosageForms.tablet' | translate }}</option>
              <option value="Capsule">{{ 'products.dosageForms.capsule' | translate }}</option>
              <option value="Syrup">{{ 'products.dosageForms.syrup' | translate }}</option>
              <option value="Injection">{{ 'products.dosageForms.injection' | translate }}</option>
              <option value="Cream">{{ 'products.dosageForms.cream' | translate }}</option>
              <option value="Ointment">{{ 'products.dosageForms.ointment' | translate }}</option>
              <option value="Drops">{{ 'products.dosageForms.drops' | translate }}</option>
              <option value="Inhaler">{{ 'products.dosageForms.inhaler' | translate }}</option>
              <option value="Powder">{{ 'products.dosageForms.powder' | translate }}</option>
              <option value="Suppository">{{ 'products.dosageForms.suppository' | translate }}</option>
            </select>
          </div>
          <div class="form-group">
            <label for="strength">{{ 'products.form.strength' | translate }}</label>
            <input type="text" id="strength" [(ngModel)]="form.strength" name="strength"
                   placeholder="500mg">
          </div>
          <div class="form-group">
            <label for="packageSize">{{ 'products.form.packageSize' | translate }}</label>
            <input type="text" id="packageSize" [(ngModel)]="form.packageSize" name="packageSize"
                   placeholder="30 tablets">
          </div>
          <div class="form-group checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="form.requiresPrescription" name="requiresPrescription">
              <span>{{ 'products.form.requiresPrescription' | translate }}</span>
            </label>
          </div>
          <div class="form-group checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="form.isControlled" name="isControlled">
              <span>{{ 'products.form.isControlled' | translate }}</span>
            </label>
          </div>
        </div>
      </section>

      <!-- Pricing -->
      <section class="form-section">
        <h2 class="section-title">{{ 'products.form.pricing' | translate }}</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="unitPrice">{{ 'products.form.unitPrice' | translate }} (KM) *</label>
            <input type="number" id="unitPrice" [(ngModel)]="form.unitPrice" name="unitPrice" required
                   step="0.01" min="0" placeholder="0.00">
          </div>
          <div class="form-group">
            <label for="costPrice">{{ 'products.form.costPrice' | translate }} (KM)</label>
            <input type="number" id="costPrice" [(ngModel)]="form.costPrice" name="costPrice"
                   step="0.01" min="0" placeholder="0.00">
          </div>
          <div class="form-group">
            <label for="taxRate">{{ 'products.form.taxRate' | translate }} (%)</label>
            <input type="number" id="taxRate" [(ngModel)]="form.taxRate" name="taxRate"
                   step="0.01" min="0" max="100" placeholder="17">
          </div>
          @if (form.unitPrice && form.costPrice) {
            <div class="form-group">
              <label>{{ 'products.form.margin' | translate }}</label>
              <div class="calculated-value">{{ calculateMargin() | number:'1.2-2' }}%</div>
            </div>
          }
        </div>
      </section>

      <!-- Product Prices (Base Pricing) -->
      <section class="form-section">
        <div class="section-header-row">
          <h2 class="section-title">Product Prices</h2>
          <button
            type="button"
            class="btn-secondary"
            [disabled]="!isEditMode()"
            (click)="startAddPrice()"
          >
            {{ 'common.add' | translate }}
          </button>
        </div>

        @if (!isEditMode()) {
          <div class="inline-muted">
            Save the product first to manage Product Prices.
          </div>
        } @else {

          @if (pricesError()) {
            <div class="inline-error">{{ pricesError() }}</div>
          }

          <div class="price-editor">
            <div class="form-grid">
              <div class="form-group">
                <label>Type</label>
                <select [(ngModel)]="priceForm.priceType" name="priceType">
                  <option [ngValue]="PriceType.Commercial">Commercial</option>
                  <option [ngValue]="PriceType.Essential">Essential</option>
                </select>
              </div>

              <div class="form-group">
                <label>Unit Price (KM)</label>
                <input type="number" step="0.01" min="0" [(ngModel)]="priceForm.unitPrice" name="priceUnitPrice" />
              </div>

              <div class="form-group">
                <label>Customer (optional)</label>
                <select [(ngModel)]="priceForm.customerId" name="priceCustomerId">
                  <option [ngValue]="null">All customers</option>
                  @for (c of customers(); track c.id) {
                    <option [ngValue]="c.id">{{ c.customerCode }} - {{ c.name }}</option>
                  }
                </select>
              </div>

              <div class="form-group">
                <label>Canton (optional)</label>
                <select [(ngModel)]="priceForm.cantonId" name="priceCantonId">
                  <option [ngValue]="null">All cantons</option>
                  @for (canton of cantons(); track canton.id) {
                    <option [ngValue]="canton.id">{{ canton.name }} ({{ canton.code }})</option>
                  }
                </select>
              </div>
            </div>

            <div class="form-grid price-editor-grid-2">
              <div class="form-group">
                <label>Valid From</label>
                <div class="date-input-wrapper">
                  <input
                    type="text"
                    inputmode="numeric"
                    placeholder="dd.MM.yyyy"
                    [ngModel]="validFromText"
                    (ngModelChange)="onValidFromTextChange($event)"
                    (blur)="normalizeValidFrom()"
                    name="priceValidFrom"
                  />
                  <input
                    type="date"
                    class="hidden-date-picker"
                    [value]="priceForm.validFrom"
                    (change)="onNativeValidFromChange($event)"
                    #validFromPicker
                  />
                  <button type="button" class="calendar-icon" (click)="validFromPicker.showPicker()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                      <line x1="16" y1="2" x2="16" y2="6" />
                      <line x1="8" y1="2" x2="8" y2="6" />
                      <line x1="3" y1="10" x2="21" y2="10" />
                    </svg>
                  </button>
                </div>
              </div>

              <div class="form-group">
                <label>Valid To (optional)</label>
                <div class="date-input-wrapper">
                  <input
                    type="text"
                    inputmode="numeric"
                    placeholder="dd.MM.yyyy"
                    [ngModel]="validToText"
                    (ngModelChange)="onValidToTextChange($event)"
                    (blur)="normalizeValidTo()"
                    name="priceValidTo"
                  />
                  <input
                    type="date"
                    class="hidden-date-picker"
                    [value]="priceForm.validTo ?? ''"
                    (change)="onNativeValidToChange($event)"
                    #validToPicker
                  />
                  <button type="button" class="calendar-icon" (click)="validToPicker.showPicker()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                      <line x1="16" y1="2" x2="16" y2="6" />
                      <line x1="8" y1="2" x2="8" y2="6" />
                      <line x1="3" y1="10" x2="21" y2="10" />
                    </svg>
                  </button>
                </div>
              </div>

              <div class="form-group">
                <label>Priority</label>
                <input type="number" step="1" [(ngModel)]="priceForm.priority" name="pricePriority" />
              </div>

              <div class="form-group price-active-field">
                <label>Active</label>
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="priceForm.isActive" name="priceIsActive" />
                </label>
              </div>
            </div>

            <div class="price-actions">
              <button
                type="button"
                class="btn-primary"
                [disabled]="savingPrice() || !priceForm.validFrom || !(priceForm.unitPrice > 0)"
                (click)="savePrice()"
              >
                {{ editingPriceId ? ('common.save' | translate) : ('common.add' | translate) }}
              </button>
              @if (editingPriceId) {
                <button type="button" class="btn-secondary" [disabled]="savingPrice()" (click)="cancelEditPrice()">
                  {{ 'common.cancel' | translate }}
                </button>
              }
            </div>
          </div>

          @if (loadingPrices()) {
            <div class="inline-muted">{{ 'common.loading' | translate }}</div>
          } @else if (productPrices().length === 0) {
            <div class="inline-muted">No prices defined for this product.</div>
          } @else {
            <div class="prices-table-wrapper">
              <table class="prices-table">
                <thead>
                  <tr>
                    <th>Type</th>
                    <th class="text-right">Unit Price</th>
                    <th>Customer</th>
                    <th>Canton</th>
                    <th>Valid From</th>
                    <th>Valid To</th>
                    <th class="text-right">Priority</th>
                    <th class="text-center">Active</th>
                    <th class="text-center">Valid Now</th>
                    <th class="text-center actions-cell">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  @for (pp of productPrices(); track pp.id) {
                    <tr>
                      <td>{{ getPriceTypeLabel(pp.priceType) }}</td>
                      <td class="text-right">{{ pp.unitPrice | number:'1.2-2' }} KM</td>
                      <td>{{ pp.customerName || '-' }}</td>
                      <td>{{ pp.cantonName || (pp.cantonId ? ('#' + pp.cantonId) : '-') }}</td>
                      <td>{{ pp.validFrom | date:'dd.MM.yyyy' }}</td>
                      <td>{{ pp.validTo ? (pp.validTo | date:'dd.MM.yyyy') : '-' }}</td>
                      <td class="text-right">{{ pp.priority }}</td>
                      <td class="text-center">{{ pp.isActive ? 'Yes' : 'No' }}</td>
                      <td class="text-center">{{ pp.isValid ? 'Yes' : 'No' }}</td>
                      <td class="text-center actions-cell">
                        <div class="row-actions">
                          <button type="button" class="action-btn" [title]="'common.edit' | translate" (click)="startEditPrice(pp)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                          </button>
                          <button
                            type="button"
                            class="action-btn action-btn-danger"
                            [disabled]="deletingPriceId() === pp.id"
                            [title]="'common.delete' | translate"
                            (click)="deletePrice(pp)"
                          >
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                          </button>
                        </div>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        }
      </section>

      <!-- Inventory -->
      <section class="form-section">
        <h2 class="section-title">{{ 'products.form.inventory' | translate }}</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="reorderLevel">{{ 'products.form.reorderLevel' | translate }} *</label>
            <input type="number" id="reorderLevel" [(ngModel)]="form.reorderLevel" name="reorderLevel" required
                   min="0" placeholder="10">
          </div>
          <div class="form-group">
            <label for="reorderQuantity">{{ 'products.form.reorderQuantity' | translate }} *</label>
            <input type="number" id="reorderQuantity" [(ngModel)]="form.reorderQuantity" name="reorderQuantity" required
                   min="0" placeholder="50">
          </div>
        </div>
      </section>

      <!-- Image & Status -->
      <section class="form-section">
        <h2 class="section-title">{{ 'products.form.imageStatus' | translate }}</h2>
        <div class="form-grid">
          <div class="form-group full-width">
            <label for="imageUrl">{{ 'products.form.imageUrl' | translate }}</label>
            <input type="url" id="imageUrl" [(ngModel)]="form.imageUrl" name="imageUrl"
                   placeholder="https://example.com/image.jpg">
            @if (form.imageUrl) {
              <div class="image-preview">
                <img [src]="form.imageUrl" alt="Product preview" (error)="onImageError($event)">
              </div>
            }
          </div>
          <div class="form-group checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="form.isActive" name="isActive">
              <span>{{ 'products.form.isActive' | translate }}</span>
            </label>
          </div>
          <div class="form-group checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="form.isFeatured" name="isFeatured">
              <span>{{ 'products.form.isFeatured' | translate }}</span>
            </label>
          </div>
        </div>
      </section>

      <!-- Form Actions (Mobile) -->
      <div class="form-actions-mobile">
        <button type="button" class="btn-secondary" routerLink="/products">
          {{ 'common.cancel' | translate }}
        </button>
        <button type="submit" class="btn-primary" [disabled]="saving()">
          @if (saving()) {
            <span class="spinner"></span>
          }
          {{ 'common.save' | translate }}
        </button>
      </div>
    </form>
  }
</div>
