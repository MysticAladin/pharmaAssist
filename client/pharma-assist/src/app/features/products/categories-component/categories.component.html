<div class="categories-page">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">{{ 'categories.title' | translate }}</h1>
      <p class="page-subtitle">{{ 'categories.subtitle' | translate }}</p>
    </div>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 5v14M5 12h14"/>
      </svg>
      {{ 'categories.addCategory' | translate }}
    </button>
  </div>

  <!-- Filters Bar -->
  <div class="filters-bar">
    <app-search-input
      [placeholder]="'common.search' | translate"
      [debounceTime]="300"
      (searchChange)="onSearch($event)"
    ></app-search-input>

    <div class="filter-group">
      <label class="toggle-filter">
        <input
          type="checkbox"
          [(ngModel)]="showActiveOnly"
          (ngModelChange)="filterCategories()"
        >
        <span>{{ 'common.activeOnly' | translate }}</span>
      </label>
    </div>
  </div>

  <!-- Column Templates (must exist even when table is not rendered yet) -->
  <ng-template #nameTemplate let-row>
    <div class="category-name-cell">
      <div class="category-icon">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
        </svg>
      </div>
      <div class="category-info">
        <span class="category-name">{{ row.name }}</span>
        @if (row.nameLocal && row.nameLocal !== row.name) {
          <span class="category-name-local">{{ row.nameLocal }}</span>
        }
      </div>
    </div>
  </ng-template>

  <ng-template #parentTemplate let-row>
    @if (row.parentName) {
      <span class="parent-badge">{{ row.parentName }}</span>
    } @else {
      <span class="no-parent"></span>
    }
  </ng-template>

  <ng-template #statusTemplate let-row>
    <app-status-badge
      [label]="row.isActive ? 'common.active' : 'common.inactive'"
      [variant]="row.isActive ? 'success' : 'neutral'"
      [shouldTranslate]="true"
      [dot]="true"
    ></app-status-badge>
  </ng-template>

  <ng-template #productsTemplate let-row>
    <span class="product-count">{{ row.productCount || 0 }}</span>
  </ng-template>

  <ng-template #actionsTemplate let-row>
    <div class="action-buttons">
      <button class="btn-icon" (click)="editCategory(row); $event.stopPropagation()" [title]="'common.edit' | translate">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
        </svg>
      </button>
      <button
        class="btn-icon btn-icon-danger"
        (click)="confirmDelete(row); $event.stopPropagation()"
        [title]="'common.delete' | translate"
        [disabled]="(row.productCount || 0) > 0"
      >
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="3 6 5 6 21 6"/>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
          <line x1="10" y1="11" x2="10" y2="17"/>
          <line x1="14" y1="11" x2="14" y2="17"/>
        </svg>
      </button>
    </div>
  </ng-template>

  <!-- Categories Table -->
  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>{{ 'common.loading' | translate }}</p>
    </div>
  } @else if (filteredCategories().length === 0 && !searchTerm) {
    <app-empty-state
      icon="folder"
      [title]="'categories.empty.title' | translate"
      [description]="'categories.empty.description' | translate"
      [actionLabel]="'categories.addCategory' | translate"
      (actionClick)="openCreateModal()"
    ></app-empty-state>
  } @else if (filteredCategories().length === 0 && searchTerm) {
    <app-empty-state
      icon="search"
      [title]="'common.noSearchResults' | translate"
      [description]="'common.tryDifferentSearch' | translate"
    ></app-empty-state>
  } @else {
    <app-data-table
      [data]="filteredCategories()"
      [columns]="columns"
      [selectable]="false"
      [hoverable]="true"
      [striped]="true"
      (rowClick)="onRowClick($event)"
    ></app-data-table>
  }

  <!-- Category Form Modal -->
  <app-modal
    [isOpen]="showFormModal()"
    [title]="(editingCategory() ? 'categories.editCategory' : 'categories.addCategory') | translate"
    [size]="'medium'"
    (closeModal)="closeFormModal()"
  >
    <div class="modal-body" body>
      <form class="category-form" (ngSubmit)="saveCategory()">
        <div class="form-row">
          <div class="form-group">
            <label for="name">{{ 'categories.form.name' | translate }} *</label>
            <input
              type="text"
              id="name"
              [(ngModel)]="formData.name"
              name="name"
              class="form-control"
              required
              [placeholder]="'categories.form.namePlaceholder' | translate"
            >
          </div>
          <div class="form-group">
            <label for="nameLocal">{{ 'categories.form.nameLocal' | translate }}</label>
            <input
              type="text"
              id="nameLocal"
              [(ngModel)]="formData.nameLocal"
              name="nameLocal"
              class="form-control"
              [placeholder]="'categories.form.nameLocalPlaceholder' | translate"
            >
          </div>
        </div>

        <div class="form-group">
          <label for="description">{{ 'categories.form.description' | translate }}</label>
          <textarea
            id="description"
            [(ngModel)]="formData.description"
            name="description"
            class="form-control"
            rows="3"
            [placeholder]="'categories.form.descriptionPlaceholder' | translate"
          ></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="parentId">{{ 'categories.form.parent' | translate }}</label>
            <select
              id="parentId"
              [(ngModel)]="formData.parentId"
              name="parentId"
              class="form-control"
            >
              <option [ngValue]="null">{{ 'categories.form.noParent' | translate }}</option>
              @for (cat of getParentOptions(); track cat.id) {
                <option [ngValue]="cat.id">{{ cat.name }}</option>
              }
            </select>
          </div>
          <div class="form-group">
            <label for="sortOrder">{{ 'categories.form.sortOrder' | translate }}</label>
            <input
              type="number"
              id="sortOrder"
              [(ngModel)]="formData.sortOrder"
              name="sortOrder"
              class="form-control"
              min="0"
            >
          </div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input
              type="checkbox"
              [(ngModel)]="formData.isActive"
              name="isActive"
            >
            <span>{{ 'categories.form.isActive' | translate }}</span>
          </label>
        </div>
      </form>
    </div>
    <div class="modal-footer" footer>
      <button type="button" class="btn btn-secondary" (click)="closeFormModal()">
        {{ 'common.cancel' | translate }}
      </button>
      <button
        type="button"
        class="btn btn-primary"
        (click)="saveCategory()"
        [disabled]="saving() || !formData.name"
      >
        @if (saving()) {
          <span class="spinner-small"></span>
        }
        {{ (editingCategory() ? 'common.save' : 'common.create') | translate }}
      </button>
    </div>
  </app-modal>

  <!-- Delete Confirmation Dialog -->
  <app-confirm-dialog
    [isOpen]="showDeleteDialog()"
    [title]="'categories.delete.title' | translate"
    [message]="'categories.delete.message' | translate : { name: deletingCategory()?.name }"
    [confirmLabel]="'common.delete' | translate"
    [cancelLabel]="'common.cancel' | translate"
    variant="danger"
    (confirmed)="deleteCategory()"
    (cancelled)="cancelDelete()"
  ></app-confirm-dialog>
</div>
