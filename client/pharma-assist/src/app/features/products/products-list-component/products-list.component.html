<div class="products-page">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">{{ 'products.title' | translate }}</h1>
      <p class="page-subtitle">{{ 'products.subtitle' | translate }}</p>
    </div>
    <div class="header-actions">
      <div class="export-dropdown" [class.open]="showExportMenu()">
        <button class="btn btn-secondary" (click)="toggleExportMenu()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          {{ 'common.export' | translate }}
        </button>
        @if (showExportMenu()) {
          <div class="export-menu">
            <button (click)="exportToCSV()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
              </svg>
              CSV
            </button>
            <button (click)="exportToExcel()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
              </svg>
              Excel
            </button>
            <button (click)="exportToPDF()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
              </svg>
              PDF
            </button>
          </div>
        }
      </div>
      <button class="btn btn-primary" (click)="createProduct()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 5v14M5 12h14"/>
        </svg>
        {{ 'products.addProduct' | translate }}
      </button>
    </div>
  </div>

  <!-- Filters Bar -->
  <div class="filters-bar">
    <app-search-input
      [placeholder]="'products.searchPlaceholder'"
      (search)="onSearch($event)"
    ></app-search-input>

    <div class="filter-group">
      <select
        class="filter-select"
        [ngModel]="filters().categoryId || ''"
        (ngModelChange)="onCategoryChange($event)"
      >
        <option value="">{{ 'products.allCategories' | translate }}</option>
        @for (cat of categories(); track cat.id) {
          <option [value]="cat.id">{{ cat.name }}</option>
        }
      </select>

      <select
        class="filter-select"
        [ngModel]="filters().manufacturerId || ''"
        (ngModelChange)="onManufacturerChange($event)"
      >
        <option value="">{{ 'products.allManufacturers' | translate }}</option>
        @for (mfr of manufacturers(); track mfr.id) {
          <option [value]="mfr.id">{{ mfr.name }}</option>
        }
      </select>

      <label class="filter-checkbox">
        <input
          type="checkbox"
          [ngModel]="filters().activeOnly"
          (ngModelChange)="onActiveOnlyChange($event)"
        />
        <span>{{ 'products.activeOnly' | translate }}</span>
      </label>

      <button class="btn btn-filter" [class.active]="showAdvancedFilters()" (click)="toggleAdvancedFilters()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
        </svg>
        {{ 'products.filters.advanced' | translate }}
        @if (activeFilterCount() > 0) {
          <span class="filter-badge">{{ activeFilterCount() }}</span>
        }
      </button>
    </div>
  </div>

  <!-- Advanced Filters Panel -->
  @if (showAdvancedFilters()) {
    <div class="advanced-filters-panel" @slideDown>
      <div class="filters-grid">
        <!-- Price Range -->
        <div class="filter-section">
          <label class="filter-label">{{ 'products.filters.priceRange' | translate }}</label>
          <div class="price-range">
            <input
              type="number"
              class="filter-input"
              [placeholder]="'products.filters.minPrice' | translate"
              [ngModel]="filters().minPrice"
              (ngModelChange)="onMinPriceChange($event)"
              min="0"
              step="0.01"
            />
            <span class="range-separator">â€”</span>
            <input
              type="number"
              class="filter-input"
              [placeholder]="'products.filters.maxPrice' | translate"
              [ngModel]="filters().maxPrice"
              (ngModelChange)="onMaxPriceChange($event)"
              min="0"
              step="0.01"
            />
          </div>
        </div>

        <!-- Stock Status -->
        <div class="filter-section">
          <label class="filter-label">{{ 'products.filters.stockStatus' | translate }}</label>
          <select
            class="filter-select full-width"
            [ngModel]="filters().stockStatus || 'all'"
            (ngModelChange)="onStockStatusChange($event)"
          >
            <option value="all">{{ 'products.filters.stockAll' | translate }}</option>
            <option value="inStock">{{ 'products.filters.stockInStock' | translate }}</option>
            <option value="lowStock">{{ 'products.filters.stockLow' | translate }}</option>
            <option value="outOfStock">{{ 'products.filters.stockOut' | translate }}</option>
          </select>
        </div>

        <!-- Prescription Required -->
        <div class="filter-section">
          <label class="filter-label">{{ 'products.filters.prescriptionRequired' | translate }}</label>
          <select
            class="filter-select full-width"
            [ngModel]="prescriptionFilterValue()"
            (ngModelChange)="onPrescriptionChange($event)"
          >
            <option value="all">{{ 'products.filters.prescriptionAll' | translate }}</option>
            <option value="yes">{{ 'products.filters.prescriptionYes' | translate }}</option>
            <option value="no">{{ 'products.filters.prescriptionNo' | translate }}</option>
          </select>
        </div>

        <!-- Barcode Status -->
        <div class="filter-section">
          <label class="filter-label">{{ 'products.filters.barcode' | translate }}</label>
          <select
            class="filter-select full-width"
            [ngModel]="barcodeFilterValue()"
            (ngModelChange)="onBarcodeChange($event)"
          >
            <option value="all">{{ 'products.filters.barcodeAll' | translate }}</option>
            <option value="yes">{{ 'products.filters.barcodeYes' | translate }}</option>
            <option value="no">{{ 'products.filters.barcodeNo' | translate }}</option>
          </select>
        </div>

        <!-- Expiry Status -->
        <div class="filter-section">
          <label class="filter-label">{{ 'products.filters.expiryStatus' | translate }}</label>
          <select
            class="filter-select full-width"
            [ngModel]="filters().expiryStatus || 'all'"
            (ngModelChange)="onExpiryStatusChange($event)"
          >
            <option value="all">{{ 'products.filters.expiryAll' | translate }}</option>
            <option value="valid">{{ 'products.filters.expiryValid' | translate }}</option>
            <option value="expiringSoon">{{ 'products.filters.expiringSoon' | translate }}</option>
            <option value="expired">{{ 'products.filters.expiryExpired' | translate }}</option>
          </select>
        </div>

        <!-- Sort By -->
        <div class="filter-section">
          <label class="filter-label">{{ 'products.filters.sortBy' | translate }}</label>
          <div class="sort-controls">
            <select
              class="filter-select"
              [ngModel]="filters().sortBy || 'name'"
              (ngModelChange)="onSortByChange($event)"
            >
              <option value="name">{{ 'products.columns.name' | translate }}</option>
              <option value="unitPrice">{{ 'products.columns.price' | translate }}</option>
              <option value="stockQuantity">{{ 'products.columns.stock' | translate }}</option>
              <option value="createdAt">{{ 'products.filters.dateAdded' | translate }}</option>
            </select>
            <button
              class="sort-direction-btn"
              [class.desc]="filters().sortDirection === 'desc'"
              (click)="toggleSortDirection()"
              [title]="(filters().sortDirection === 'desc' ? 'products.filters.sortDesc' : 'products.filters.sortAsc') | translate"
            >
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12l7-7 7 7"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Filter Actions -->
      <div class="filter-actions">
        <button class="btn btn-ghost" (click)="clearAdvancedFilters()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
          {{ 'products.filters.clearAll' | translate }}
        </button>
        <button class="btn btn-primary" (click)="applyFilters()">
          {{ 'products.filters.apply' | translate }}
        </button>
      </div>
    </div>
  }

  <!-- Bulk Actions Bar -->
  @if (selectedCount() > 0) {
    <div class="bulk-actions-bar">
      <div class="bulk-info">
        <button class="btn-checkbox" (click)="clearSelection()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
        <span>{{ selectedCount() }} {{ 'bulk.selected' | translate }}</span>
      </div>
      <div class="bulk-buttons">
        <button class="btn btn-bulk" (click)="bulkToggleStatus(true)" [disabled]="bulkActionLoading()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          {{ 'bulk.activate' | translate }}
        </button>
        <button class="btn btn-bulk" (click)="bulkToggleStatus(false)" [disabled]="bulkActionLoading()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
          </svg>
          {{ 'bulk.deactivate' | translate }}
        </button>
        <button class="btn btn-bulk" (click)="openBulkPriceDialog()" [disabled]="bulkActionLoading()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="1" x2="12" y2="23"/>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
          </svg>
          {{ 'bulk.updatePrices' | translate }}
        </button>
        <div class="bulk-export-dropdown">
          <button class="btn btn-bulk" (click)="toggleBulkExportDropdown()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            {{ 'bulk.exportSelected' | translate }}
          </button>
          @if (showBulkExportDropdown()) {
            <div class="bulk-export-menu">
              <button (click)="exportSelected('csv')">CSV</button>
              <button (click)="exportSelected('excel')">Excel</button>
              <button (click)="exportSelected('pdf')">PDF</button>
            </div>
          }
        </div>
        <button class="btn btn-bulk btn-danger" (click)="openBulkDeleteDialog()" [disabled]="bulkActionLoading()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
          </svg>
          {{ 'bulk.delete' | translate }}
        </button>
      </div>
    </div>
  }

  <!-- Data Table -->
  <app-data-table
    [columnDefs]="columns"
    [items]="products()"
    [isLoading]="loading()"
    [enableActions]="true"
    [enableRowClick]="true"
    [actionsTemplate]="actionsTemplate"
    (sortChange)="onTableSort($event)"
    (rowClick)="viewProduct($event)"
  >
    <ng-container emptyState>
      <app-empty-state
        [title]="'products.noProducts'"
        [description]="'products.noProductsDescription'"
        [isCompact]="true"
      >
        <button class="btn btn-primary" (click)="createProduct()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14M5 12h14"/>
          </svg>
          {{ 'products.addProduct' | translate }}
        </button>
      </app-empty-state>
    </ng-container>
  </app-data-table>

  <!-- Actions Template -->
  <ng-template #actionsTemplate let-row>
    <div class="row-actions">
      <button class="action-btn" (click)="viewProduct(row, $event)" title="{{ 'common.view' | translate }}">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
          <circle cx="12" cy="12" r="3"/>
        </svg>
      </button>
      <button class="action-btn" (click)="editProduct(row, $event)" title="{{ 'common.edit' | translate }}">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
        </svg>
      </button>
      <button class="action-btn action-btn-danger" (click)="confirmDelete(row, $event)" title="{{ 'common.delete' | translate }}">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
        </svg>
      </button>
    </div>
  </ng-template>

  <!-- Pagination -->
  @if (totalItems() > 0) {
    <app-pagination
      [page]="filters().page"
      [size]="filters().pageSize"
      [totalItems]="totalItems()"
      (pageChange)="onPageChange($event)"
    ></app-pagination>
  }

  <!-- Delete Confirmation Dialog -->
  <app-confirm-dialog
    [open]="showDeleteDialog()"
    [title]="'products.deleteProduct'"
    [message]="'products.deleteConfirmation'"
    [confirmText]="'common.delete'"
    [cancelText]="'common.cancel'"
    type="danger"
    [isLoading]="deleting()"
    (openChange)="showDeleteDialog.set($event)"
    (confirm)="deleteProduct()"
    (cancel)="showDeleteDialog.set(false)"
  ></app-confirm-dialog>
</div>
